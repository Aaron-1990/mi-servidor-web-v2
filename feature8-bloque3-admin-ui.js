// ============================================================================
// Feature 8 - Bloque 3: Admin UI - Equipment Tab
// Run: node feature8-bloque3-admin-ui.js
// Location: Run from C:\Aplicaciones\mi-servidor-web-v2
// ============================================================================
const fs = require('fs');
const path = require('path');

const ADMIN_PATH = path.join(__dirname, 'public', 'admin.html');

let content = fs.readFileSync(ADMIN_PATH, 'utf8');
console.log('[INFO] Read admin.html (' + content.length + ' chars)');

// --- Check if already patched ---
if (content.includes('equipment-table')) {
  console.log('[SKIP] Equipment tab already patched');
  process.exit(0);
}

// --- STEP 1: Inject new CSS before </style> ---
var css = [];
css.push('        /* === Feature 8: Equipment Tab Styles === */');
css.push('        .eq-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }');
css.push('        .eq-toolbar select, .eq-toolbar input { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; padding: 8px 12px; border-radius: 4px; font-size: 0.85rem; }');
css.push('        .eq-toolbar select { min-width: 160px; }');
css.push('        .eq-toolbar input { flex: 1; min-width: 200px; }');
css.push('        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; }');
css.push('        .btn-primary { background: #f59e0b; color: #0f172a; }');
css.push('        .btn-primary:hover { background: #fbbf24; }');
css.push('        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }');
css.push('        .btn-success { background: #22c55e; color: #fff; }');
css.push('        .btn-danger { background: #ef4444; color: #fff; }');
css.push('        .btn-secondary { background: #334155; color: #e2e8f0; }');
css.push('        .btn-secondary:hover { background: #475569; }');
css.push('        .btn-test { background: #6366f1; color: #fff; }');
css.push('        .btn-test:hover { background: #818cf8; }');
css.push('        .btn:disabled { opacity: 0.5; cursor: not-allowed; }');
css.push('        .eq-count { color: #94a3b8; font-size: 0.85rem; margin-left: auto; }');
css.push('        .eq-type { font-size: 0.75rem; padding: 2px 8px; border-radius: 3px; font-family: monospace; }');
css.push('        .eq-type-breq { background: #1e3a5f; color: #38bdf8; }');
css.push('        .eq-type-bcmp { background: #3b1f1f; color: #fb923c; }');
css.push('        .eq-parallel { font-size: 0.75rem; color: #a78bfa; }');
css.push('        .toggle { cursor: pointer; font-weight: 600; }');
css.push('        .toggle-on { color: #22c55e; }');
css.push('        .toggle-off { color: #ef4444; }');
css.push('        .actions-cell { display: flex; gap: 6px; }');
css.push('        /* Modal */');
css.push('        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: flex-start; padding-top: 60px; }');
css.push('        .modal-overlay.active { display: flex; }');
css.push('        .modal { background: #1e293b; border: 1px solid #334155; border-radius: 8px; width: 520px; max-height: 80vh; overflow-y: auto; padding: 24px; }');
css.push('        .modal h3 { margin-bottom: 20px; font-size: 1.1rem; color: #f59e0b; }');
css.push('        .form-group { margin-bottom: 14px; }');
css.push('        .form-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; }');
css.push('        .form-group input, .form-group select { width: 100%; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; }');
css.push('        .form-group input:focus, .form-group select:focus { border-color: #f59e0b; outline: none; }');
css.push('        .form-row { display: flex; gap: 12px; }');
css.push('        .form-row .form-group { flex: 1; }');
css.push('        .form-hint { font-size: 0.75rem; color: #64748b; margin-top: 3px; }');
css.push('        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #334155; }');
css.push('        .radio-group { display: flex; gap: 16px; margin-top: 4px; }');
css.push('        .radio-group label { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #e2e8f0; cursor: pointer; text-transform: none; }');
css.push('        .tooltip-icon { display: inline-block; width: 16px; height: 16px; background: #334155; color: #94a3b8; border-radius: 50%; text-align: center; font-size: 0.7rem; line-height: 16px; cursor: help; position: relative; }');
css.push('        .tooltip-icon:hover::after { content: attr(data-tip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #0f172a; color: #e2e8f0; padding: 8px 12px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; border: 1px solid #334155; z-index: 10; max-width: 320px; white-space: normal; }');
css.push('        .url-test-row { display: flex; gap: 8px; align-items: flex-start; }');
css.push('        .url-test-row input { flex: 1; }');
css.push('        .test-result { font-size: 0.8rem; margin-top: 4px; padding: 4px 8px; border-radius: 3px; }');
css.push('        .test-ok { background: #14532d; color: #4ade80; }');
css.push('        .test-fail { background: #450a0a; color: #fca5a5; }');
css.push('        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; font-size: 0.85rem; z-index: 2000; animation: fadeIn 0.3s; }');
css.push('        .toast-success { background: #14532d; color: #4ade80; border: 1px solid #22c55e; }');
css.push('        .toast-error { background: #450a0a; color: #fca5a5; border: 1px solid #ef4444; }');
css.push('        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }');

var cssBlock = css.join('\n');
content = content.replace('    </style>', cssBlock + '\n    </style>');
console.log('[OK] CSS injected');

// --- STEP 2: Replace equipment placeholder with real HTML ---
var oldPlaceholder = '<div class="placeholder">Equipment management - Coming in Feature 8</div>';
if (!content.includes(oldPlaceholder)) {
  console.error('[ERROR] Equipment placeholder not found');
  process.exit(1);
}

var html = [];
html.push('<h2 style="font-size:1.1rem; margin-bottom:12px;">Equipment Management</h2>');
html.push('            <div class="eq-toolbar">');
html.push('                <select id="eq-filter-line" onchange="loadEquipment()"><option value="">All Lines</option></select>');
html.push('                <select id="eq-filter-process" onchange="filterTable()"><option value="">All Processes</option></select>');
html.push('                <input type="text" id="eq-search" placeholder="Search by ID or name..." oninput="filterTable()">');
html.push('                <span class="eq-count" id="eq-count"></span>');
html.push('                <button class="btn btn-primary" onclick="openModal()">+ New Equipment</button>');
html.push('            </div>');
html.push('            <table>');
html.push('                <thead><tr>');
html.push('                    <th>ID</th><th>Name</th><th>Process</th><th>Type</th><th>Design CT</th><th>Parallel</th><th>Order</th><th>Status</th><th>Actions</th>');
html.push('                </tr></thead>');
html.push('                <tbody id="equipment-table"></tbody>');
html.push('            </table>');
html.push('');
html.push('            <!-- Modal -->');
html.push('            <div class="modal-overlay" id="eq-modal">');
html.push('                <div class="modal">');
html.push('                    <h3 id="modal-title">New Equipment</h3>');
html.push('                    <div class="form-group">');
html.push('                        <label>Line</label>');
html.push('                        <select id="f-line-id"></select>');
html.push('                    </div>');
html.push('                    <div class="form-row">');
html.push('                        <div class="form-group">');
html.push('                            <label>Equipment ID</label>');
html.push('                            <input type="text" id="f-eq-id" placeholder="e.g. LEAKTEST_03" style="text-transform:uppercase">');
html.push('                            <div class="form-hint">Uppercase, alphanumeric + underscore</div>');
html.push('                        </div>');
html.push('                        <div class="form-group">');
html.push('                            <label>Name</label>');
html.push('                            <input type="text" id="f-eq-name" placeholder="e.g. Leak Test Station 3">');
html.push('                        </div>');
html.push('                    </div>');
html.push('                    <div class="form-row">');
html.push('                        <div class="form-group">');
html.push('                            <label>Process</label>');
html.push('                            <select id="f-process"></select>');
html.push('                            <div class="form-hint">Select existing or type new in ID</div>');
html.push('                        </div>');
html.push('                        <div class="form-group">');
html.push('                            <label>Design CT (sec)</label>');
html.push('                            <input type="number" id="f-design-ct" step="0.01" min="0.01" placeholder="e.g. 25.5">');
html.push('                        </div>');
html.push('                    </div>');
html.push('                    <div class="form-group">');
html.push('                        <label>Equipment Type <span class="tooltip-icon" data-tip="BREQ+BCMP: Entry and exit events. CT = BCMP - BREQ of same serial. BCMP Only: Completion event only. CT = throughput over 30-piece buffer.">?</span></label>');
html.push('                        <div class="radio-group">');
html.push('                            <label><input type="radio" name="f-eq-type" value="BREQ_BCMP" checked> BREQ + BCMP</label>');
html.push('                            <label><input type="radio" name="f-eq-type" value="BCMP_ONLY"> BCMP Only</label>');
html.push('                        </div>');
html.push('                    </div>');
html.push('                    <div class="form-group">');
html.push('                        <label>CSV URL</label>');
html.push('                        <div class="url-test-row">');
html.push('                            <input type="text" id="f-csv-url" placeholder="http://10.3.x.x/...">');
html.push('                            <button class="btn btn-test btn-sm" onclick="testUrl()" id="btn-test-url">Test</button>');
html.push('                        </div>');
html.push('                        <div id="url-test-result"></div>');
html.push('                    </div>');
html.push('                    <div class="form-row">');
html.push('                        <div class="form-group">');
html.push('                            <label>Process Order</label>');
html.push('                            <input type="number" id="f-order" min="1" placeholder="e.g. 8">');
html.push('                        </div>');
html.push('                        <div class="form-group">');
html.push('                            <label>Target OEE (%)</label>');
html.push('                            <input type="number" id="f-target-oee" min="0" max="100" value="85">');
html.push('                        </div>');
html.push('                    </div>');
html.push('                    <div class="form-row">');
html.push('                        <div class="form-group">');
html.push('                            <label><input type="checkbox" id="f-is-parallel"> Parallel Equipment</label>');
html.push('                        </div>');
html.push('                        <div class="form-group" id="parallel-fields" style="display:none">');
html.push('                            <label>Parallel Group</label>');
html.push('                            <input type="number" id="f-parallel-group" min="0" placeholder="e.g. 3">');
html.push('                        </div>');
html.push('                    </div>');
html.push('                    <div class="form-group">');
html.push('                        <label>Sub-Line Group</label>');
html.push('                        <input type="text" id="f-sub-line" placeholder="e.g. AUTO_LINE (optional)">');
html.push('                    </div>');
html.push('                    <div class="form-actions">');
html.push('                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>');
html.push('                        <button class="btn btn-primary" id="btn-save" onclick="saveEquipment()">Save</button>');
html.push('                    </div>');
html.push('                </div>');
html.push('            </div>');

content = content.replace(oldPlaceholder, html.join('\n'));
console.log('[OK] Equipment HTML injected');

// --- STEP 3: Inject JavaScript before closing </script> ---
var js = [];
js.push('');
js.push('        // === Feature 8: Equipment CRUD ===');
js.push('        var allEquipment = [];');
js.push('        var editingId = null;');
js.push('');
js.push('        function loadEquipment() {');
js.push('            var lineId = document.getElementById("eq-filter-line").value;');
js.push('            var url = API_BASE + "/api/equipment";');
js.push('            if (lineId) url += "?line_id=" + lineId;');
js.push('            fetch(url).then(function(r) { return r.json(); }).then(function(data) {');
js.push('                if (!data.success) return;');
js.push('                allEquipment = data.equipment;');
js.push('                populateProcessFilter(allEquipment);');
js.push('                filterTable();');
js.push('            });');
js.push('        }');
js.push('');
js.push('        function populateProcessFilter(equipment) {');
js.push('            var procs = [];');
js.push('            equipment.forEach(function(e) {');
js.push('                if (procs.indexOf(e.process_name) === -1) procs.push(e.process_name);');
js.push('            });');
js.push('            procs.sort();');
js.push('            var sel = document.getElementById("eq-filter-process");');
js.push('            var cur = sel.value;');
js.push('            sel.innerHTML = "<option value=\\"\\">All Processes</option>" + procs.map(function(p) {');
js.push('                return "<option value=\\"" + p + "\\">" + p + "</option>";');
js.push('            }).join("");');
js.push('            sel.value = cur;');
js.push('        }');
js.push('');
js.push('        function filterTable() {');
js.push('            var proc = document.getElementById("eq-filter-process").value;');
js.push('            var search = document.getElementById("eq-search").value.toLowerCase();');
js.push('            var filtered = allEquipment.filter(function(e) {');
js.push('                if (proc && e.process_name !== proc) return false;');
js.push('                if (search && e.equipment_id.toLowerCase().indexOf(search) === -1 && e.equipment_name.toLowerCase().indexOf(search) === -1) return false;');
js.push('                return true;');
js.push('            });');
js.push('            document.getElementById("eq-count").textContent = filtered.length + " of " + allEquipment.length + " equipment";');
js.push('            renderTable(filtered);');
js.push('        }');
js.push('');
js.push('        function renderTable(equipment) {');
js.push('            var tbody = document.getElementById("equipment-table");');
js.push('            if (equipment.length === 0) {');
js.push('                tbody.innerHTML = "<tr><td colspan=9 style=\\"text-align:center;color:#64748b;padding:40px\\">No equipment found</td></tr>";');
js.push('                return;');
js.push('            }');
js.push('            tbody.innerHTML = equipment.map(function(e) {');
js.push('                var typeClass = e.equipment_type === "BREQ_BCMP" ? "eq-type-breq" : "eq-type-bcmp";');
js.push('                var typeLabel = e.equipment_type === "BREQ_BCMP" ? "BREQ+BCMP" : "BCMP Only";');
js.push('                var statusClass = e.is_active ? "toggle-on" : "toggle-off";');
js.push('                var statusText = e.is_active ? "ON" : "OFF";');
js.push('                var parallel = e.is_parallel ? "G" + (e.parallel_group || "?") : "-";');
js.push('                return "<tr>" +');
js.push('                    "<td style=\\"font-family:monospace;font-size:0.8rem\\">" + e.equipment_id + "</td>" +');
js.push('                    "<td>" + e.equipment_name + "</td>" +');
js.push('                    "<td>" + e.process_name + "</td>" +');
js.push('                    "<td><span class=\\"eq-type " + typeClass + "\\">" + typeLabel + "</span></td>" +');
js.push('                    "<td>" + parseFloat(e.design_ct) + "s</td>" +');
js.push('                    "<td class=eq-parallel>" + parallel + "</td>" +');
js.push('                    "<td>" + (e.process_order || "-") + "</td>" +');
js.push('                    "<td><span class=\\"toggle " + statusClass + "\\" onclick=\\"toggleStatus(\'" + e.equipment_id + "\'," + !e.is_active + ")\\" style=cursor:pointer>" + statusText + "</span></td>" +');
js.push('                    "<td class=actions-cell><button class=\\"btn btn-secondary btn-sm\\" onclick=\\"openEdit(\'" + e.equipment_id + "\')\\">Edit</button></td>" +');
js.push('                "</tr>";');
js.push('            }).join("");');
js.push('        }');
js.push('');
js.push('        function toggleStatus(eqId, newStatus) {');
js.push('            fetch(API_BASE + "/api/equipment/" + eqId + "/status", {');
js.push('                method: "PUT",');
js.push('                headers: { "Content-Type": "application/json" },');
js.push('                body: JSON.stringify({ is_active: newStatus })');
js.push('            }).then(function(r) { return r.json(); }).then(function(data) {');
js.push('                if (data.success) {');
js.push('                    showToast(eqId + " " + (newStatus ? "activated" : "deactivated"), "success");');
js.push('                    loadEquipment();');
js.push('                } else {');
js.push('                    showToast("Error: " + data.error, "error");');
js.push('                }');
js.push('            });');
js.push('        }');
js.push('');
js.push('        // --- Modal ---');
js.push('        function openModal() {');
js.push('            editingId = null;');
js.push('            document.getElementById("modal-title").textContent = "New Equipment";');
js.push('            document.getElementById("f-eq-id").value = "";');
js.push('            document.getElementById("f-eq-id").removeAttribute("disabled");');
js.push('            document.getElementById("f-eq-name").value = "";');
js.push('            document.getElementById("f-design-ct").value = "";');
js.push('            document.getElementById("f-csv-url").value = "";');
js.push('            document.getElementById("f-order").value = "";');
js.push('            document.getElementById("f-target-oee").value = "85";');
js.push('            document.getElementById("f-is-parallel").checked = false;');
js.push('            document.getElementById("f-parallel-group").value = "";');
js.push('            document.getElementById("f-sub-line").value = "";');
js.push('            document.getElementById("parallel-fields").style.display = "none";');
js.push('            document.getElementById("url-test-result").innerHTML = "";');
js.push('            document.querySelector("input[name=f-eq-type][value=BREQ_BCMP]").checked = true;');
js.push('            loadModalDropdowns();');
js.push('            document.getElementById("eq-modal").classList.add("active");');
js.push('        }');
js.push('');
js.push('        function openEdit(eqId) {');
js.push('            var eq = allEquipment.find(function(e) { return e.equipment_id === eqId; });');
js.push('            if (!eq) return;');
js.push('            editingId = eqId;');
js.push('            document.getElementById("modal-title").textContent = "Edit: " + eqId;');
js.push('            document.getElementById("f-eq-id").value = eq.equipment_id;');
js.push('            document.getElementById("f-eq-id").setAttribute("disabled", "disabled");');
js.push('            document.getElementById("f-eq-name").value = eq.equipment_name;');
js.push('            document.getElementById("f-design-ct").value = parseFloat(eq.design_ct);');
js.push('            document.getElementById("f-csv-url").value = eq.csv_url || "";');
js.push('            document.getElementById("f-order").value = eq.process_order || "";');
js.push('            document.getElementById("f-target-oee").value = parseFloat(eq.target_oee) || 85;');
js.push('            document.getElementById("f-is-parallel").checked = eq.is_parallel;');
js.push('            document.getElementById("f-parallel-group").value = eq.parallel_group || "";');
js.push('            document.getElementById("f-sub-line").value = eq.sub_line_group || "";');
js.push('            document.getElementById("parallel-fields").style.display = eq.is_parallel ? "block" : "none";');
js.push('            document.getElementById("url-test-result").innerHTML = "";');
js.push('            var typeVal = eq.equipment_type || "BREQ_BCMP";');
js.push('            var radio = document.querySelector("input[name=f-eq-type][value=" + typeVal + "]");');
js.push('            if (radio) radio.checked = true;');
js.push('            loadModalDropdowns(eq);');
js.push('            document.getElementById("eq-modal").classList.add("active");');
js.push('        }');
js.push('');
js.push('        function closeModal() {');
js.push('            document.getElementById("eq-modal").classList.remove("active");');
js.push('            editingId = null;');
js.push('        }');
js.push('');
js.push('        function loadModalDropdowns(eq) {');
js.push('            // Lines dropdown');
js.push('            fetch(API_BASE + "/api/lines").then(function(r) { return r.json(); }).then(function(data) {');
js.push('                if (!data.success) return;');
js.push('                var sel = document.getElementById("f-line-id");');
js.push('                sel.innerHTML = data.lines.map(function(l) {');
js.push('                    return "<option value=\\"" + l.id + "\\">" + l.line_code + " - " + l.line_name + "</option>";');
js.push('                }).join("");');
js.push('                if (eq && eq.line_id) sel.value = eq.line_id;');
js.push('            });');
js.push('            // Processes dropdown');
js.push('            fetch(API_BASE + "/api/processes").then(function(r) { return r.json(); }).then(function(data) {');
js.push('                if (!data.success) return;');
js.push('                var sel = document.getElementById("f-process");');
js.push('                sel.innerHTML = "<option value=\\"\\">-- Select or type new --</option>"');
js.push('                    + data.processes.map(function(p) {');
js.push('                        return "<option value=\\"" + p + "\\">" + p + "</option>";');
js.push('                    }).join("");');
js.push('                if (eq && eq.process_name) sel.value = eq.process_name;');
js.push('            });');
js.push('        }');
js.push('');
js.push('        // Parallel checkbox toggle');
js.push('        document.getElementById("f-is-parallel").addEventListener("change", function() {');
js.push('            document.getElementById("parallel-fields").style.display = this.checked ? "block" : "none";');
js.push('        });');
js.push('');
js.push('        // --- Save ---');
js.push('        function saveEquipment() {');
js.push('            var eqType = document.querySelector("input[name=f-eq-type]:checked").value;');
js.push('            var isParallel = document.getElementById("f-is-parallel").checked;');
js.push('');
js.push('            var payload = {');
js.push('                equipment_name: document.getElementById("f-eq-name").value.trim(),');
js.push('                process_name: document.getElementById("f-process").value,');
js.push('                csv_url: document.getElementById("f-csv-url").value.trim() || null,');
js.push('                design_ct: parseFloat(document.getElementById("f-design-ct").value),');
js.push('                equipment_type: eqType,');
js.push('                target_oee: parseFloat(document.getElementById("f-target-oee").value) || 85,');
js.push('                is_parallel: isParallel,');
js.push('                process_order: parseInt(document.getElementById("f-order").value),');
js.push('                parallel_group: isParallel ? parseInt(document.getElementById("f-parallel-group").value) : null,');
js.push('                sub_line_group: document.getElementById("f-sub-line").value.trim() || null');
js.push('            };');
js.push('');
js.push('            var url, method;');
js.push('            if (editingId) {');
js.push('                url = API_BASE + "/api/equipment/" + editingId;');
js.push('                method = "PUT";');
js.push('            } else {');
js.push('                payload.equipment_id = document.getElementById("f-eq-id").value.trim().toUpperCase();');
js.push('                payload.line_id = parseInt(document.getElementById("f-line-id").value);');
js.push('                url = API_BASE + "/api/equipment";');
js.push('                method = "POST";');
js.push('            }');
js.push('');
js.push('            document.getElementById("btn-save").disabled = true;');
js.push('            document.getElementById("btn-save").textContent = "Saving...";');
js.push('');
js.push('            fetch(url, {');
js.push('                method: method,');
js.push('                headers: { "Content-Type": "application/json" },');
js.push('                body: JSON.stringify(payload)');
js.push('            }).then(function(r) { return r.json(); }).then(function(data) {');
js.push('                document.getElementById("btn-save").disabled = false;');
js.push('                document.getElementById("btn-save").textContent = "Save";');
js.push('                if (data.success) {');
js.push('                    showToast((editingId ? "Updated" : "Created") + ": " + (payload.equipment_id || editingId), "success");');
js.push('                    closeModal();');
js.push('                    loadEquipment();');
js.push('                } else {');
js.push('                    var msg = data.error;');
js.push('                    if (data.details) msg += " - " + data.details.join(", ");');
js.push('                    showToast(msg, "error");');
js.push('                }');
js.push('            }).catch(function(err) {');
js.push('                document.getElementById("btn-save").disabled = false;');
js.push('                document.getElementById("btn-save").textContent = "Save";');
js.push('                showToast("Network error: " + err.message, "error");');
js.push('            });');
js.push('        }');
js.push('');
js.push('        // --- Test URL ---');
js.push('        function testUrl() {');
js.push('            var url = document.getElementById("f-csv-url").value.trim();');
js.push('            if (!url) { showToast("Enter a URL first", "error"); return; }');
js.push('            document.getElementById("btn-test-url").disabled = true;');
js.push('            document.getElementById("btn-test-url").textContent = "Testing...";');
js.push('            document.getElementById("url-test-result").innerHTML = "";');
js.push('            fetch(API_BASE + "/api/equipment/test-url", {');
js.push('                method: "POST",');
js.push('                headers: { "Content-Type": "application/json" },');
js.push('                body: JSON.stringify({ url: url })');
js.push('            }).then(function(r) { return r.json(); }).then(function(data) {');
js.push('                document.getElementById("btn-test-url").disabled = false;');
js.push('                document.getElementById("btn-test-url").textContent = "Test";');
js.push('                var el = document.getElementById("url-test-result");');
js.push('                if (data.reachable && data.hasData) {');
js.push('                    el.innerHTML = "<div class=\\"test-result test-ok\\">Reachable - CSV data found</div>";');
js.push('                } else if (data.reachable) {');
js.push('                    el.innerHTML = "<div class=\\"test-result test-fail\\">Reachable but no CSV data (no xmp tags)</div>";');
js.push('                } else {');
js.push('                    el.innerHTML = "<div class=\\"test-result test-fail\\">Not reachable: " + (data.error || "Unknown error") + "</div>";');
js.push('                }');
js.push('            }).catch(function() {');
js.push('                document.getElementById("btn-test-url").disabled = false;');
js.push('                document.getElementById("btn-test-url").textContent = "Test";');
js.push('                document.getElementById("url-test-result").innerHTML = "<div class=\\"test-result test-fail\\">Network error</div>";');
js.push('            });');
js.push('        }');
js.push('');
js.push('        // --- Toast ---');
js.push('        function showToast(msg, type) {');
js.push('            var div = document.createElement("div");');
js.push('            div.className = "toast toast-" + type;');
js.push('            div.textContent = msg;');
js.push('            document.body.appendChild(div);');
js.push('            setTimeout(function() { div.remove(); }, 4000);');
js.push('        }');
js.push('');
js.push('        // --- Init: Load line filter + equipment on tab click ---');
js.push('        fetch(API_BASE + "/api/lines").then(function(r) { return r.json(); }).then(function(data) {');
js.push('            if (!data.success) return;');
js.push('            var sel = document.getElementById("eq-filter-line");');
js.push('            sel.innerHTML = "<option value=\\"\\">All Lines</option>" + data.lines.map(function(l) {');
js.push('                return "<option value=\\"" + l.id + "\\">" + l.line_code + "</option>";');
js.push('            }).join("");');
js.push('        });');
js.push('        loadEquipment();');

var jsBlock = js.join('\n');
content = content.replace('    </script>', jsBlock + '\n    </script>');
console.log('[OK] JavaScript injected');

// --- Write patched file ---
fs.writeFileSync(ADMIN_PATH, content, 'utf8');
console.log('[OK] admin.html patched (' + content.length + ' chars)');
console.log('');
console.log('[CHECKPOINT] Open http://10.3.0.200:3000/admin -> click Equipment tab');
console.log('  Expected: Table with 29 equipment, filters, + New Equipment button');
