<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSM Monitor</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        h1 { color: #00d4ff; margin-bottom: 10px; }
        .status { padding: 10px; background: #16213e; border-radius: 8px; margin-bottom: 20px; }
        .status.connected { border-left: 4px solid #00ff88; }
        .status.disconnected { border-left: 4px solid #ff4444; }
        .grid { display: flex; overflow-x: auto; gap: 0; padding: 10px 0; align-items: flex-start; }
        .grid::-webkit-scrollbar { height: 8px; }
        .grid::-webkit-scrollbar-track { background: #0a0a1a; }
        .grid::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .process-step { display: flex; align-items: flex-start; flex-shrink: 0; }
        .process-flow-arrow { display: flex; align-items: center; padding: 0 4px; color: #333; font-size: 1.5em; margin-top: 40px; }
        .process-card { background: #16213e; border-radius: 10px; padding: 12px; min-width: 280px; max-width: 320px; flex-shrink: 0; }
                .process-name { font-size: 0.95em; font-weight: bold; color: #00d4ff; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .process-step-num { background: #00d4ff; color: #0a0a1a; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; flex-shrink: 0; }
        .process-equip-count { font-weight: normal; font-size: 0.75em; color: #666; margin-left: auto; }
                .parallel-badge { font-size: 0.65em; color: #ffaa00; font-weight: normal; }

        /* ==================== SUB-LINE CONTAINER ==================== */
        .sub-line-container {
            background: #1a1a3a;
            border: 2px solid #2a2a5a;
            border-radius: 12px;
            padding: 10px;
            flex-shrink: 0;
            min-width: 600px;
        }
        .sub-line-header {
            font-size: 0.85em;
            font-weight: bold;
            color: #ffaa00;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sub-line-row {
            display: flex;
            align-items: flex-start;
            gap: 4px;
            margin-bottom: 6px;
        }
        .sub-line-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background: #252550;
            color: #00d4ff;
            font-size: 0.7em;
            font-weight: bold;
            padding: 8px 4px;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        .sub-line-arrow {
            display: flex;
            align-items: center;
            color: #444;
            font-size: 1em;
            padding: 0 2px;
            margin-top: 20px;
        }
        .sub-line-row .equipment {
            min-width: 220px;
            max-width: 240px;
            font-size: 0.9em;
        }
        .equipment { background: #0f0f23; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        .equipment-name { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.85em; }
        .metric { text-align: center; }
        .metric-label { color: #888; font-size: 0.75em; }
        .metric-value { font-size: 1.3em; font-weight: bold; }
        .metric-value.realtime { color: #00ff88; }
        .metric-value.hour { color: #ffaa00; }
        .metric-value.shift { color: #00d4ff; }
        .metrics-row { margin-bottom: 6px; }
        .metrics-row-label { font-size: 0.7em; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .pieces { margin-top: 8px; font-size: 0.8em; color: #888; }
        .pieces .ok { color: #00ff88; }
        .pieces .ng { color: #ff4444; }
        .timestamp { font-size: 0.8em; color: #666; }
        .totals { background: #00d4ff22; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 30px; }
        .total-item { text-align: center; }
        .total-value { font-size: 2em; font-weight: bold; color: #00d4ff; }
        .total-label { font-size: 0.8em; color: #888; }

        /* ==================== HOURLY BREAKDOWN ==================== */
        .hourly-toggle {
            margin-top: 8px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 0.8em;
            color: #00d4ff;
            background: #1a1a3e;
            border-radius: 4px;
            user-select: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .hourly-toggle:hover { background: #252550; }
        .hourly-arrow {
            display: inline-block;
            transition: transform 0.2s;
            font-size: 0.7em;
        }
        .hourly-arrow.expanded { transform: rotate(90deg); }

        /* no-animate: kills transitions during 5s restore cycle */
        .hourly-container.no-animate,
        .hourly-container.no-animate .drill-container {
            transition: none !important;
        }
        .hourly-container {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
            margin-top: 6px;
        }
        .hourly-container.expanded {
            max-height: 5000px;
            transition: max-height 0.4s ease-in;
        }
        .hourly-content {
            padding: 8px;
            background: #12122a;
            border-radius: 4px;
            border: 1px solid #2a2a4a;
        }
        .hourly-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
            height: 18px;
            cursor: pointer;
            border-radius: 2px;
            transition: background 0.15s;
        }
        .hourly-bar-row:hover { background: #1e1e40; }
        .hourly-bar-row.active { background: #252550; }
        .hourly-bar-empty { cursor: default; }
        .hourly-bar-empty:hover { background: transparent; }
        .hourly-label {
            width: 42px;
            font-size: 0.7em;
            color: #666;
            text-align: right;
            padding-right: 8px;
            flex-shrink: 0;
        }
        .hourly-bar-track {
            flex: 1;
            height: 14px;
            background: #1a1a30;
            border-radius: 2px;
            overflow: hidden;
            display: flex;
        }
        .hourly-bar-ok { height: 100%; background: #00ff88; transition: width 0.3s ease; }
        .hourly-bar-ng { height: 100%; background: #ff4444; transition: width 0.3s ease; }
        .hourly-bar-empty .hourly-bar-track { opacity: 0.3; }
        .hourly-count {
            width: 50px;
            font-size: 0.7em;
            color: #888;
            text-align: right;
            padding-left: 6px;
            flex-shrink: 0;
        }
        .hourly-summary {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #888;
            padding-top: 6px;
            border-top: 1px solid #2a2a4a;
            margin-top: 4px;
        }
        .hourly-peak { color: #ffaa00; }
        .hourly-loading {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: #666;
        }

        /* ==================== DRILL-DOWN DETAIL ==================== */
        .drill-container {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }
        .drill-container.expanded {
            max-height: 3000px;
            transition: max-height 0.4s ease-in;
        }
        .drill-content {
            margin: 4px 0 6px 42px;
            padding: 8px;
            background: #0a0a1a;
            border-radius: 4px;
            border-left: 3px solid #00d4ff;
            font-size: 0.75em;
        }
        .drill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #1a1a3a;
            color: #00d4ff;
            font-weight: bold;
        }
        .drill-close {
            cursor: pointer;
            color: #666;
            font-size: 1.2em;
            padding: 0 4px;
        }
        .drill-close:hover { color: #ff4444; }
        .drill-table-wrapper {
            max-height: 300px;
            overflow-y: auto;
        }
        .drill-table-wrapper::-webkit-scrollbar { width: 6px; }
        .drill-table-wrapper::-webkit-scrollbar-track { background: #0a0a1a; }
        .drill-table-wrapper::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .drill-table-wrapper::-webkit-scrollbar-thumb:hover { background: #555; }
        .drill-table {
            width: 100%;
            border-collapse: collapse;
        }
        .drill-table th {
            text-align: left;
            color: #888;
            font-weight: normal;
            padding: 2px 6px;
            border-bottom: 1px solid #1a1a3a;
            position: sticky;
            top: 0;
            background: #0a0a1a;
        }
        .drill-table td {
            padding: 2px 6px;
            color: #ccc;
            border-bottom: 1px solid #0f0f25;
        }
        .drill-table tr.ng-row td { color: #ff4444; }
        .drill-table tr:hover td { background: #12122e; }
        .drill-time-range {
            color: #666;
            font-size: 0.9em;
            margin-top: 4px;
        }

        /* ==================== DESIGN CT EDITABLE ==================== */
        .design-ct-display {
            display: inline-block;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            color: #aaa;
            border-bottom: 1px dashed #555;
            margin-top: 4px;
        }
        .design-ct-display:hover {
            background: #252550;
            color: #fff;
        }
        .design-ct-input {
            width: 70px;
            background: #1a1a30;
            border: 1px solid #00ff88;
            color: #00ff88;
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 3px;
            outline: none;
            margin-top: 4px;
        }
        .design-ct-saving { opacity: 0.5; pointer-events: none; }

        /* ==================== CSV URL EDITABLE ==================== */
        .csv-url-display {
            display: block;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65em;
            color: #666;
            border-bottom: 1px dashed #333;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        .csv-url-display:hover { background: #252550; color: #aaa; }
        .csv-url-input {
            width: 100%;
            box-sizing: border-box;
            background: #1a1a30;
            border: 1px solid #00d4ff;
            color: #00d4ff;
            font-size: 0.65em;
            padding: 3px 6px;
            border-radius: 3px;
            outline: none;
            margin-top: 2px;
        }
        .csv-url-saving { opacity: 0.5; pointer-events: none; }

        /* === Admin/User Mode (Feature 8) === */
        .viewer-mode .csv-url-display { display: none !important; }
        .viewer-mode .design-ct-display { cursor: default !important; }
        .viewer-mode .equipment-name a { pointer-events: none; border-bottom-color: transparent !important; cursor: default; text-decoration: none !important; }
    </style>
</head>
<body>
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:10px;"><a href="/" style="color:#94a3b8; text-decoration:none; font-size:1.2rem;" title="Back to lines">&larr;</a><h1 id="line-title" style="color:#00d4ff; margin:0;">VSM Monitor</h1></div>
    <div id="status" class="status disconnected">Connecting...</div>
    <div id="totals" class="totals"></div>
    <div id="grid" class="grid"></div>

    <script>
        var API_BASE = window.location.origin;
        var pathParts = window.location.pathname.split("/");
        var isAdmin = pathParts[1] === "admin";
        var lineCode = isAdmin ? (pathParts[3] || "GPEC5_L1") : (pathParts[2] || "GPEC5_L1");
        if (!isAdmin) document.body.classList.add("viewer-mode");
        var lineDisplay = decodeURIComponent(lineCode);
        document.getElementById('line-title').textContent = 'VSM Monitor - ' + lineDisplay;
        document.title = 'VSM ' + lineDisplay + ' - Monitor';
        if (isAdmin) {
            var backLink = document.querySelector("a[href='/']");
            if (backLink) backLink.href = "/admin";
            document.getElementById('line-title').textContent = 'VSM Admin Monitor - ' + lineDisplay;
            document.title = 'VSM ' + lineDisplay + ' - Admin Monitor';
        }

        // ==================== HOURLY BREAKDOWN MANAGER ====================

        function HourlyBreakdownManager(apiBaseUrl) {
            this.apiBaseUrl = apiBaseUrl;
            this.expandedCards = new Set();
            this.expandedDrills = new Map();
            this.cache = new Map();
            this.drillCache = new Map();
            this.refreshTimers = new Map();
            this.scrollPositions = new Map();
            this.CACHE_TTL_MS = 60000;
            this.REFRESH_INTERVAL_MS = 60000;
        }

        // ---- Public API ----

        HourlyBreakdownManager.prototype.toggle = function(equipmentId) {
            if (this.expandedCards.has(equipmentId)) {
                this._collapse(equipmentId);
            } else {
                this._expand(equipmentId);
            }
        };

        HourlyBreakdownManager.prototype.toggleDrill = function(equipmentId, hour) {
            var key = equipmentId + ':' + hour;
            if (this.expandedDrills.has(key)) {
                this._collapseDrill(equipmentId, hour);
            } else {
                this._expandDrill(equipmentId, hour);
            }
        };

        /**
         * Save scroll positions of all open drill-down tables.
         * Must be called BEFORE gridEl.innerHTML destroys the DOM.
         */
        HourlyBreakdownManager.prototype.saveScrollPositions = function() {
            this.scrollPositions.clear();
            var self = this;
            this.expandedDrills.forEach(function(val, key) {
                var parts = key.split(':');
                var eqId = parts[0];
                var hour = parts[1];
                var wrapper = document.querySelector('#drill-' + eqId + '-' + hour + ' .drill-table-wrapper');
                if (wrapper && wrapper.scrollTop > 0) {
                    self.scrollPositions.set(key, wrapper.scrollTop);
                }
            });
        };

        /**
         * Restore scroll positions after DOM has been rebuilt.
         * Must be called AFTER restoreExpandedState completes.
         */
        HourlyBreakdownManager.prototype.restoreScrollPositions = function() {
            var self = this;
            this.scrollPositions.forEach(function(scrollTop, key) {
                var parts = key.split(':');
                var eqId = parts[0];
                var hour = parts[1];
                var wrapper = document.querySelector('#drill-' + eqId + '-' + hour + ' .drill-table-wrapper');
                if (wrapper) {
                    wrapper.scrollTop = scrollTop;
                }
            });
        };

        /**
         * Restore all previously expanded cards and drills after a DOM re-render.
         */
        HourlyBreakdownManager.prototype.restoreExpandedState = function() {
            var self = this;
            this.expandedCards.forEach(function(equipmentId) {
                var cached = self._getCached(equipmentId);
                if (cached) {
                    self._applyExpanded(equipmentId, cached);
                } else {
                    self._expand(equipmentId);
                }
            });
        };

        // ---- Expand / Collapse Cards ----

        HourlyBreakdownManager.prototype._expand = function(equipmentId) {
            var self = this;
            this.expandedCards.add(equipmentId);
            this._setArrowState(equipmentId, true);
            this._setContainerExpanded(equipmentId, true);
            this._showLoading(equipmentId);

            this._fetchData(equipmentId).then(function(data) {
                self._renderBarChart(equipmentId, data);
                self._startAutoRefresh(equipmentId);
            }).catch(function(error) {
                self._showError(equipmentId, error.message);
            });
        };

        HourlyBreakdownManager.prototype._collapse = function(equipmentId) {
            this.expandedCards.delete(equipmentId);
            var self = this;
            var toRemove = [];
            this.expandedDrills.forEach(function(val, key) {
                if (key.indexOf(equipmentId + ':') === 0) toRemove.push(key);
            });
            toRemove.forEach(function(k) {
                self.expandedDrills.delete(k);
                self.scrollPositions.delete(k);
            });
            this._setArrowState(equipmentId, false);
            this._setContainerExpanded(equipmentId, false);
            this._stopAutoRefresh(equipmentId);
        };

        HourlyBreakdownManager.prototype._applyExpanded = function(equipmentId, data) {
            var self = this;
            var container = document.getElementById('hourly-' + equipmentId);
            if (container) {
                container.classList.add('no-animate');
                container.classList.add('expanded');
            }
            this._setArrowState(equipmentId, true);
            this._renderBarChart(equipmentId, data);

            // Restore open drills
            this.expandedDrills.forEach(function(drillData, key) {
                if (key.indexOf(equipmentId + ':') === 0) {
                    var hour = parseInt(key.split(':')[1]);
                    self._renderDrillDetail(equipmentId, hour, drillData);
                }
            });

            // Re-enable transitions after paint
            if (container) {
                requestAnimationFrame(function() {
                    container.classList.remove('no-animate');
                });
            }
        };

        // ---- Drill-Down ----

        HourlyBreakdownManager.prototype._expandDrill = function(equipmentId, hour) {
            var self = this;
            var key = equipmentId + ':' + hour;
            var drillId = 'drill-' + equipmentId + '-' + hour;
            var container = document.getElementById(drillId);
            if (!container) return;

            container.innerHTML = '<div class="drill-content" style="color:#666">Loading records...</div>';
            container.classList.add('expanded');

            this._fetchDrillData(equipmentId, hour).then(function(data) {
                self.expandedDrills.set(key, data);
                self._renderDrillDetail(equipmentId, hour, data);
            }).catch(function(error) {
                container.innerHTML = '<div class="drill-content" style="color:#ff4444">Error: ' + error.message + '</div>';
            });
        };

        HourlyBreakdownManager.prototype._collapseDrill = function(equipmentId, hour) {
            var key = equipmentId + ':' + hour;
            this.expandedDrills.delete(key);
            this.scrollPositions.delete(key);
            var drillId = 'drill-' + equipmentId + '-' + hour;
            var container = document.getElementById(drillId);
            if (container) container.classList.remove('expanded');
        };

        HourlyBreakdownManager.prototype._renderDrillDetail = function(equipmentId, hour, data) {
            var drillId = 'drill-' + equipmentId + '-' + hour;
            var container = document.getElementById(drillId);
            if (!container || !data.records) return;

            container.classList.add('expanded');

            var rowsHtml = '';
            for (var i = 0; i < data.records.length; i++) {
                var r = data.records[i];
                var time = r.scan_time || new Date(r.scanned_at).toLocaleTimeString();
                var rowClass = r.is_ng ? 'ng-row' : '';
                rowsHtml += '<tr class="' + rowClass + '">'
                    + '<td>' + (i + 1) + '</td>'
                    + '<td>' + r.serial_number + '</td>'
                    + '<td>' + r.status + '</td>'
                    + '<td>' + time + '</td>'
                    + '</tr>';
            }

            var s = data.summary;
            var firstTime = s.first_scan_time || (s.first_scan_at ? new Date(s.first_scan_at).toLocaleTimeString() : '-');
            var lastTime = s.last_scan_time || (s.last_scan_at ? new Date(s.last_scan_at).toLocaleTimeString() : '-');

            container.innerHTML = '<div class="drill-content">'
                + '<div class="drill-header">'
                + '<span>' + data.label + ' - ' + data.record_count + ' records (' + s.pieces_ok + ' OK / ' + s.pieces_ng + ' NG)</span>'
                + '<span class="drill-close" onclick="hourlyManager.toggleDrill(\'' + equipmentId + '\',' + hour + ')">x</span>'
                + '</div>'
                + '<div class="drill-table-wrapper">'
                + '<table class="drill-table">'
                + '<thead><tr><th>#</th><th>Serial</th><th>Status</th><th>Time</th></tr></thead>'
                + '<tbody>' + rowsHtml + '</tbody>'
                + '</table>'
                + '</div>'
                + '<div class="drill-time-range">Range: ' + firstTime + ' - ' + lastTime + '</div>'
                + '</div>';
        };

        // ---- Data Layer ----

        HourlyBreakdownManager.prototype._fetchData = function(equipmentId, bypassCache) {
            if (!bypassCache) {
                var cached = this._getCached(equipmentId);
                if (cached) return Promise.resolve(cached);
            }
            var self = this;
            return fetch(this.apiBaseUrl + '/api/metrics/' + equipmentId + '/hourly')
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(json) {
                    if (!json.success) throw new Error(json.error || 'Unknown error');
                    self.cache.set(equipmentId, { data: json, fetchedAt: Date.now() });
                    return json;
                });
        };

        HourlyBreakdownManager.prototype._fetchDrillData = function(equipmentId, hour) {
            var cacheKey = equipmentId + ':' + hour;
            var cached = this.drillCache.get(cacheKey);
            if (cached && (Date.now() - cached.fetchedAt < this.CACHE_TTL_MS)) {
                return Promise.resolve(cached.data);
            }
            var self = this;
            return fetch(this.apiBaseUrl + '/api/metrics/' + equipmentId + '/hourly/' + hour)
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(json) {
                    if (!json.success) throw new Error(json.error || 'Unknown error');
                    self.drillCache.set(cacheKey, { data: json, fetchedAt: Date.now() });
                    return json;
                });
        };

        HourlyBreakdownManager.prototype._getCached = function(equipmentId) {
            var entry = this.cache.get(equipmentId);
            if (!entry) return null;
            if (Date.now() - entry.fetchedAt > this.CACHE_TTL_MS) return null;
            return entry.data;
        };

        // ---- Auto Refresh ----

        HourlyBreakdownManager.prototype._startAutoRefresh = function(equipmentId) {
            this._stopAutoRefresh(equipmentId);
            var self = this;
            var timerId = setInterval(function() {
                if (!self.expandedCards.has(equipmentId)) {
                    self._stopAutoRefresh(equipmentId);
                    return;
                }
                self._fetchData(equipmentId, true).then(function(data) {
                    self._renderBarChart(equipmentId, data);
                }).catch(function() {});
            }, this.REFRESH_INTERVAL_MS);
            this.refreshTimers.set(equipmentId, timerId);
        };

        HourlyBreakdownManager.prototype._stopAutoRefresh = function(equipmentId) {
            var timerId = this.refreshTimers.get(equipmentId);
            if (timerId) {
                clearInterval(timerId);
                this.refreshTimers.delete(equipmentId);
            }
        };

        // ---- DOM Helpers ----

        HourlyBreakdownManager.prototype._setArrowState = function(equipmentId, expanded) {
            var arrow = document.getElementById('arrow-' + equipmentId);
            if (arrow) arrow.classList.toggle('expanded', expanded);
        };

        HourlyBreakdownManager.prototype._setContainerExpanded = function(equipmentId, expanded) {
            var container = document.getElementById('hourly-' + equipmentId);
            if (container) container.classList.toggle('expanded', expanded);
        };

        HourlyBreakdownManager.prototype._showLoading = function(equipmentId) {
            var container = document.getElementById('hourly-' + equipmentId);
            if (container) container.innerHTML = '<div class="hourly-loading">Loading hourly data...</div>';
        };

        HourlyBreakdownManager.prototype._showError = function(equipmentId, message) {
            var container = document.getElementById('hourly-' + equipmentId);
            if (container) container.innerHTML = '<div class="hourly-loading" style="color:#ff4444">Error: ' + message + '</div>';
        };

        HourlyBreakdownManager.prototype._renderBarChart = function(equipmentId, data) {
            var container = document.getElementById('hourly-' + equipmentId);
            if (!container || !data.hours) return;

            var maxCount = 1;
            for (var i = 0; i < data.hours.length; i++) {
                if (data.hours[i].total > maxCount) maxCount = data.hours[i].total;
            }

            function fmtHour(h) { return h + '-' + ((h + 1) % 24); }
            var barsHtml = '';
            for (var i = 0; i < data.hours.length; i++) {
                var h = data.hours[i];
                var okWidth = (h.pieces_ok / maxCount) * 100;
                var ngWidth = (h.pieces_ng / maxCount) * 100;
                var isEmpty = h.total === 0;
                var rowClass = isEmpty ? 'hourly-bar-row hourly-bar-empty' : 'hourly-bar-row';
                var countText = isEmpty ? '' : (h.pieces_ok + (h.pieces_ng > 0 ? '+' + h.pieces_ng : ''));
                var clickAttr = isEmpty ? '' : ' onclick="hourlyManager.toggleDrill(\'' + equipmentId + '\',' + h.hour + ')"';

                barsHtml += '<div class="' + rowClass + '"' + clickAttr + '>'
                    + '<span class="hourly-label">' + fmtHour(h.hour) + '</span>'
                    + '<div class="hourly-bar-track">'
                    + '<div class="hourly-bar-ok" style="width:' + okWidth + '%"></div>'
                    + '<div class="hourly-bar-ng" style="width:' + ngWidth + '%"></div>'
                    + '</div>'
                    + '<span class="hourly-count">' + countText + '</span>'
                    + '</div>'
                    + '<div class="drill-container" id="drill-' + equipmentId + '-' + h.hour + '"></div>';
            }

            var t = data.totals;
            var peakText = t.peak_hour
                ? 'Peak: ' + fmtHour(t.peak_hour.hour) + ' (' + t.peak_hour.count + ' pcs)'
                : 'No production';

            container.innerHTML = '<div class="hourly-content">'
                + barsHtml
                + '<div class="hourly-summary">'
                + '<span>Total: <span class="ok">' + t.pieces_ok + '</span> OK / <span class="ng">' + t.pieces_ng + '</span> NG</span>'
                + '<span class="hourly-peak">' + peakText + '</span>'
                + '</div></div>';
        };

        // ==================== INSTANTIATE ====================
        // ==================== DESIGN CT INLINE EDIT ====================
        // Inline editing removed - monitor is read-only

        function editDesignCT(equipmentId, currentValue) {
            if (!isAdmin) return;
            editingCT = equipmentId;
            var span = document.getElementById('dct-' + equipmentId);
            if (!span) return;
            var input = document.createElement('input');
            input.type = 'number';
            input.className = 'design-ct-input';
            input.value = currentValue || '';
            input.min = '0.01';
            input.step = '0.01';
            input.onkeydown = function(e) {
                if (e.key === 'Enter') saveDesignCT(equipmentId, input);
                if (e.key === 'Escape') { editingCT = null; input.replaceWith(span); }
            };
            input.onblur = function() { saveDesignCT(equipmentId, input); };
            span.replaceWith(input);
            input.focus();
            input.select();
        }

        function saveDesignCT(equipmentId, input) {
            var value = parseFloat(input.value);
            if (!value || value <= 0) {
                editingCT = null;
                location.reload();
                return;
            }
            input.classList.add('design-ct-saving');
            fetch(API_BASE + '/api/equipment/' + equipmentId + '/design-ct', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ design_ct: value })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                editingCT = null;
                if (data.success) {
                    var span = document.createElement('span');
                    span.className = 'design-ct-display';
                    span.id = 'dct-' + equipmentId;
                    span.onclick = function() { editDesignCT(equipmentId, data.design_ct); };
                    span.textContent = 'Design: ' + data.design_ct + 's';
                    input.replaceWith(span);
                }
            })
            .catch(function() { editingCT = null; location.reload(); });
        }

        // ==================== CSV URL INLINE EDIT ====================
        

        function editCsvUrl(equipmentId, currentUrl) {
            if (!isAdmin) return;
            editingURL = equipmentId;
            var div = document.getElementById('url-' + equipmentId);
            if (!div) return;
            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'csv-url-input';
            input.value = currentUrl || '';
            input.placeholder = 'http://...';
            input.onkeydown = function(e) {
                if (e.key === 'Enter') saveCsvUrl(equipmentId, input);
                if (e.key === 'Escape') { editingURL = null; input.replaceWith(div); }
            };
            input.onblur = function() { saveCsvUrl(equipmentId, input); };
            div.replaceWith(input);
            input.focus();
            input.select();
        }

        function saveCsvUrl(equipmentId, input) {
            var url = input.value.trim();
            if (!url || (!url.startsWith('http://') && !url.startsWith('https://'))) {
                editingURL = null;
                location.reload();
                return;
            }
            input.classList.add('csv-url-saving');
            fetch(API_BASE + '/api/equipment/' + equipmentId + '/csv-url', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ csv_url: url })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                editingURL = null;
                if (data.success) {
                    var div = document.createElement('div');
                    div.className = 'csv-url-display';
                    div.id = 'url-' + equipmentId;
                    div.title = data.csv_url;
                    div.onclick = function() { editCsvUrl(equipmentId, data.csv_url); };
                    div.textContent = 'URL: ' + data.csv_url.substring(data.csv_url.lastIndexOf('/') + 1);
                    input.replaceWith(div);
                }
            })
            .catch(function() { editingURL = null; location.reload(); });
        }


        // ==================== SUB-LINE GROUP RENDER ====================
        function renderSubLineGroup(groupProcs) {
            var lineCount = 0;
            groupProcs.forEach(function(p) {
                p.equipments.forEach(function(eq) {
                    var pg = eq.parallel_group || 1;
                    if (pg > lineCount) lineCount = pg;
                });
            });

            var h = '<div class="process-step"><div class="sub-line-container">';
            h += '<div class="sub-line-header">';
            h += '<span class="process-step-num" style="background:#ffaa00">' + groupProcs[0].process_order + '-' + groupProcs[groupProcs.length-1].process_order + '</span>';
            h += 'Automated Sub-Lines';
            h += '<span class="process-equip-count">' + lineCount + ' lines x ' + groupProcs.length + ' processes</span>';
            h += '</div>';

            for (var line = 1; line <= lineCount; line++) {
                h += '<div class="sub-line-row">';
                h += '<div class="sub-line-label">Line ' + String.fromCharCode(64 + line) + '</div>';

                groupProcs.forEach(function(proc, pidx) {
                    if (pidx > 0) h += '<div class="sub-line-arrow">&#9654;</div>';
                    var eq = null;
                    proc.equipments.forEach(function(e) {
                        if ((e.parallel_group || 1) === line) eq = e;
                    });
                    if (!eq) return;

                    h += '<div class="equipment">';
                    h += '<div class="equipment-name"><a href="' + eq.csv_url + '" target="_blank" style="color:#fff;text-decoration:none;border-bottom:1px dotted #555">' + (eq.equipment_name || eq.equipment_id) + '</a></div>';
                    h += '<div class="metrics-row"><div class="metrics-row-label">CT Equipo</div><div class="metrics">';
                    h += '<div class="metric"><div class="metric-label">RT</div><div class="metric-value realtime">' + fmt(eq.ct_equipo_realtime) + 's</div></div>';
                    h += '<div class="metric"><div class="metric-label">1 Hour</div><div class="metric-value hour">' + fmt(eq.ct_equipo_hour) + 's</div></div>';
                    h += '<div class="metric"><div class="metric-label">Shift</div><div class="metric-value shift">' + fmt(eq.ct_equipo_shift) + 's</div></div>';
                    h += '</div></div>';
                    h += '<div class="metrics-row"><div class="metrics-row-label">CT Proceso</div><div class="metrics">';
                    h += '<div class="metric"><div class="metric-label">RT</div><div class="metric-value realtime">' + fmt(eq.ct_proceso_realtime) + 's</div></div>';
                    h += '<div class="metric"><div class="metric-label">1 Hour</div><div class="metric-value hour">' + fmt(eq.ct_proceso_hour) + 's</div></div>';
                    h += '<div class="metric"><div class="metric-label">Shift</div><div class="metric-value shift">' + fmt(eq.ct_proceso_shift) + 's</div></div>';
                    h += '</div></div>';
                    h += '<div class="pieces"><span class="ok">' + eq.pieces_ok_shift + ' OK</span> / <span class="ng">' + eq.pieces_ng_shift + ' NG</span></div>';
                    h += '<div class="csv-url-display" onclick="editCsvUrl(\x27' + eq.equipment_id + '\x27, \x27' + (eq.csv_url || '').replace(/'/g, "\\'") + '\x27)" id="url-' + eq.equipment_id + '" title="' + (eq.csv_url || 'No URL') + '">URL: ' + (eq.csv_url ? eq.csv_url.substring(eq.csv_url.lastIndexOf('/') + 1) : 'N/A') + '</div>';
                    h += '<div><span class="design-ct-display" onclick="editDesignCT(\x27' + eq.equipment_id + '\x27, ' + (eq.design_ct || 0) + ')" id="dct-' + eq.equipment_id + '">Design: ' + (eq.design_ct ? eq.design_ct + 's' : 'N/A') + '</span></div>';
                    h += '<div class="hourly-toggle" onclick="hourlyManager.toggle(\x27' + eq.equipment_id + '\x27)">';
                    h += '<span class="hourly-arrow" id="arrow-' + eq.equipment_id + '">&#9654;</span>';
                    h += 'Hourly Breakdown</div>';
                    h += '<div class="hourly-container" id="hourly-' + eq.equipment_id + '"></div>';
                    h += '</div>';
                });

                h += '</div>';
            }

            h += '</div></div>';
            return h;
        }

        var hourlyManager = new HourlyBreakdownManager(API_BASE);

        // ==================== SOCKET.IO ====================
        var socket = io(API_BASE);
        var statusEl = document.getElementById('status');
        var totalsEl = document.getElementById('totals');
        var gridEl = document.getElementById('grid');

        socket.on('connect', function() {
            socket.emit('join-line', lineCode);
            statusEl.className = 'status connected';
            statusEl.innerHTML = 'Connected <span class="timestamp">Socket ID: ' + socket.id + '</span>';
        });

        socket.on('disconnect', function() {
            statusEl.className = 'status disconnected';
            statusEl.textContent = 'Disconnected - Reconnecting...';
        });

        function fmt(val) { var n = parseFloat(val); return isNaN(n) ? '-' : n.toFixed(1); }

        socket.on('vsm-data', function(data) {
            // Read-only mode - always re-render
            var time = new Date(data.timestamp).toLocaleTimeString();
            statusEl.innerHTML = 'Connected - Shift: <strong>' + data.shift + '</strong> <span class="timestamp">Last update: ' + time + '</span>';

            var totalOK = 0, totalNG = 0, totalEquip = 0;
            data.processes.forEach(function(p) {
                p.equipments.forEach(function(e) {
                    totalOK += parseInt(e.pieces_ok_shift) || 0;
                    totalNG += parseInt(e.pieces_ng_shift) || 0;
                    totalEquip++;
                });
            });

            totalsEl.innerHTML = '<div class="total-item"><div class="total-value">' + totalEquip + '</div><div class="total-label">Equipments</div></div>'
                + '<div class="total-item"><div class="total-value" style="color:#00ff88">' + totalOK.toLocaleString() + '</div><div class="total-label">Pieces OK</div></div>'
                + '<div class="total-item"><div class="total-value" style="color:#ff4444">' + totalNG + '</div><div class="total-label">Pieces NG</div></div>'
                + '<div class="total-item"><div class="total-value">' + ((totalOK+totalNG)>0?((totalOK/(totalOK+totalNG))*100).toFixed(1):'0.0') + '%</div><div class="total-label">Yield</div></div>';

            var html = '';
            var procs = data.processes;
            var i = 0;
            while (i < procs.length) {
                var process = procs[i];
                // Check for sub-line group
                if (process.sub_line_group) {
                    var groupProcs = [];
                    var groupName = process.sub_line_group;
                    while (i < procs.length && procs[i].sub_line_group === groupName) {
                        groupProcs.push(procs[i]);
                        i++;
                    }
                    if (html !== '') html += '<div class="process-flow-arrow">&#9654;</div>';
                    html += renderSubLineGroup(groupProcs);
                    continue;
                }
                if (html !== '') html += '<div class="process-flow-arrow">&#9654;</div>';
                html += '<div class="process-step"><div class="process-card">';
                var eqCount = process.equipments.length;
                var parallelTag = process.has_parallel_lines ? ' <span class="parallel-badge">[' + eqCount + ' parallel]</span>' : '';
                html += '<div class="process-name"><span class="process-step-num">' + process.process_order + '</span>' + process.process_name + parallelTag + '<span class="process-equip-count">' + eqCount + ' eq</span></div>';

                process.equipments.forEach(function(eq) {
                    html += '<div class="equipment">';
                    html += '<div class="equipment-name"><a href="' + eq.csv_url + '" target="_blank" style="color:#fff;text-decoration:none;border-bottom:1px dotted #555">' + (eq.equipment_name || eq.equipment_id) + '</a></div>';
                    html += '<div class="metrics-row"><div class="metrics-row-label">CT Equipo</div><div class="metrics">';
                    html += '<div class="metric"><div class="metric-label">RT</div><div class="metric-value realtime">' + fmt(eq.ct_equipo_realtime) + 's</div></div>';
                    html += '<div class="metric"><div class="metric-label">1 Hour</div><div class="metric-value hour">' + fmt(eq.ct_equipo_hour) + 's</div></div>';
                    html += '<div class="metric"><div class="metric-label">Shift</div><div class="metric-value shift">' + fmt(eq.ct_equipo_shift) + 's</div></div>';
                    html += '</div></div>';

                    html += '<div class="metrics-row"><div class="metrics-row-label">CT Proceso</div><div class="metrics">';
                    html += '<div class="metric"><div class="metric-label">RT</div><div class="metric-value realtime">' + fmt(eq.ct_proceso_realtime) + 's</div></div>';
                    html += '<div class="metric"><div class="metric-label">1 Hour</div><div class="metric-value hour">' + fmt(eq.ct_proceso_hour) + 's</div></div>';
                    html += '<div class="metric"><div class="metric-label">Shift</div><div class="metric-value shift">' + fmt(eq.ct_proceso_shift) + 's</div></div>';
                    html += '</div></div>';

                    html += '<div class="pieces">Pieces: <span class="ok">' + eq.pieces_ok_shift + ' OK</span> / <span class="ng">' + eq.pieces_ng_shift + ' NG</span> | Samples: ' + eq.samples_shift + '</div>';
                    html += '<div class="csv-url-display" onclick="editCsvUrl(\'' + eq.equipment_id + '\', \'' + (eq.csv_url || '').replace(/'/g, "\\'" ) + '\')"  id="url-' + eq.equipment_id + '" title="' + (eq.csv_url || 'No URL') + '">URL: ' + (eq.csv_url ? eq.csv_url.substring(eq.csv_url.lastIndexOf('/') + 1) : 'N/A') + '</div>';
                    html += '<div><span class="design-ct-display" onclick="editDesignCT(\'' + eq.equipment_id + '\', ' + (eq.design_ct || 0) + ')" id="dct-' + eq.equipment_id + '">Design: ' + (eq.design_ct ? eq.design_ct + 's' : 'N/A') + '</span></div>';

                    html += '<div class="hourly-toggle" onclick="hourlyManager.toggle(\'' + eq.equipment_id + '\')">';
                    html += '<span class="hourly-arrow" id="arrow-' + eq.equipment_id + '">&#9654;</span>';
                    html += 'Hourly Breakdown</div>';
                    html += '<div class="hourly-container" id="hourly-' + eq.equipment_id + '"></div>';
                    html += '</div>';
                });
                html += '</div></div>';
                i++;
            }

            // 1. Save scroll positions before destroying DOM
            hourlyManager.saveScrollPositions();

            // 2. Replace DOM
            gridEl.innerHTML = html;

            // 3. Restore expanded states (no-animate prevents visual glitch)
            hourlyManager.restoreExpandedState();

            // 4. Restore scroll positions after layout settles
            setTimeout(function() {
                hourlyManager.restoreScrollPositions();
            }, 50);
        });
    </script>
</body>
</html>




